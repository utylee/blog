<%inherit file="base.html"/>

<%block name="script">
	## nginx 에서 static 을 호스팅하느라 상대경로를 바꿨습니다
	##<link rel="stylesheet" href="../static/css/add.css">
	<link rel="stylesheet" href="/static/css/add.css">
	##<link rel="stylesheet" href="/static/css/spin.css">
	## fontawesome 직접 호스팅
	## ../ 에 webfonts 폴더만 추가로 넣으니 되었습니다
	<link rel="stylesheet" href="/static/css/fontawesome.all.min.css">
	## fontawemsome 호스팅을 받는 방법
	##<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
	##<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/regular.css" integrity="sha384-aubIA90W7NxJ+Ly4QHAqo1JBSwQ0jejV75iHhj59KRwVjLVHjuhS3LkDAoa/ltO4" crossorigin="anonymous">
	##<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/fontawesome.css" integrity="sha384-jLuaxTTBR42U2qJ/pm4JRouHkEDHkVqH0T1nyQXn1mZ7Snycpf6Rl25VBNthU4z0" crossorigin="anonymous">
	##<script src="/static/js/spin.js"></script>
	<script charset="utf-8">
		// 차트에서 포인트 갯수를 정의합니다
		window.chart_column_num = 24;
		window.cur_itemset = '${current_itemset}';
		window.socket = 0;
		window.cur_user = 'guest';
		window.itemsets = [];
		window.img_host = 'https://wow.zamimg.com/images/wow/icons/large/';
		window.chart_chains = new Array;
		window.server = '아즈샤라';
		window.form_opened = new Array;
		for (let i=0;i<6;i++) {
			form_opened[i] = 0;
		}
		function show_item_form(num) {
			//alert('div-form-item'+num);
			//alert(document.getElementById('div-form-item'+num).style.display);
			if(form_opened[num]){
				closeForm(num);
			}
			else {
				openForm(num);
			}
		}
		function submit_item_form(num) {
			//alert('div-form-item'+num);
			//alert(document.getElementById('div-form-item'+num).style.display);
			closeForm(num);
			var i_name = document.getElementById('input-item'+num).value;
			i_name = i_name.trim();
			if(i_name) {
				## vanilla js 를 이용해봅니다
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if(this.readyState == 4 && this.status == 200) {
						var data = JSON.parse(this.responseText);
						update_indiv(data);
					}
				};
				xhttp.open("GET", '/update_indiv/' + num + '/' + server + '/' + \
								cur_user + '/' + cur_itemset + '/' + i_name,true);
				xhttp.send();
				/*
				$.getJSON('/update_indiv/' + num + '/' + server + '/' + i_name , \
							function(data){update_indiv(data);});
							*/
			}
		}
		function submit_itemset_form(num) {
			//alert('div-form-item'+num);
			//alert(document.getElementById('div-form-item'+num).style.display);
			closeSetForm();
			var s_name = document.getElementById('input-itemset').value;
			s_name = s_name.trim();
			//alert(s_name);
			if(s_name) {
				## vanilla js 를 이용해봅니다
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if(this.readyState == 4 && this.status == 200) {
						var data = JSON.parse(this.responseText);
						if(data.success == '1') {
							## 생성성공하였을 경우 처리합니다
							document.getElementById('input-itemset').value = '';
							change_itemset(s_name);
							var xhttp = new XMLHttpRequest();
							xhttp.onreadystatechange = function() {
								if (this.readyState == 4 && this.status == 200) {
									var data = JSON.parse(this.responseText);
									update_page(data);
								}
							};
							## 마지막 'd'는 itemset의 성질을 나타냅니다. default로서 fame증가등을 하지 않습니다
							xhttp.open("GET", '/update/' + server + '/' + \
												cur_user + '/' + s_name , true);
							xhttp.send();
						}
						else if (data.success == '0') {
							alert('이미 있는 세트명입니다');
						}
						//update_indiv(data);
					}
				};
				xhttp.open("GET", '/create_itemset/' + cur_user + '/' + s_name, true);
				xhttp.send();
				/*
				$.getJSON('/update_indiv/' + num + '/' + server + '/' + i_name , \
							function(data){update_indiv(data);});
							*/
			}
		}

		function update_chart(a, b) {
			if(checked[a] != b){
				checked[a] = b;
				min_chain_ = chart_chains[a];
				//alert(min_chain_[min_chain_.length - 1]);
				//eval('chLine' + i).data = min_chain_[min_chain_.length - 1] / 10000;
				var data_ = [],
					len_ = min_chain_.length;
				//alert(min_chain_[0]);
				//30분 주기일 경우
				if(b == 0){
					for (let j=len_ - chart_column_num;j<=len_ - 1;j++){
						data_.push(min_chain_[j] / 10000);
					}
					var labels_ = [];
					for(let l_=0;l_<chart_column_num;l_++){
						labels_.push("");
					}
				}
				//60분 주기일 경우
				else if(b == 1){
					for (let j=len_ - chart_column_num*2 + 1;j<=len_ - 1;j+=2){
						data_.push(min_chain_[j] / 10000);
					}
					var labels_ = [];
					for(let l_=0;l_<chart_column_num;l_++){
						labels_.push("");
					}
				}
				//60*2분 주기일 경우
				else if(b == 2){
					for (let j=len_ - chart_column_num*4 + 3;j<=len_ - 1;j+=4){
						data_.push(min_chain_[j] / 10000);
					}
					var labels_ = [];
					for(let l_=0;l_<chart_column_num;l_++){
						labels_.push("");
					}
				}
				//30*2*7(=420)분 주기일 경우
				else if(b == 3){
					for (let j=len_ - chart_column_num*14 + 13;j<=len_ - 1;j+=14){
						data_.push(min_chain_[j] / 10000);
					}
					var labels_ = [];
					for(let l_=0;l_<chart_column_num;l_++){
						labels_.push("");
					}
				}
				//30*2*24(=1440)분 주기일 경우
				//30*2*30(=1800)분 주기일 경우
				else if(b == 4){
					##for (let j=len_ - chart_column_num*48 + 47;j<=len_ - 1;j+=48){
					for (let j=len_ - chart_column_num*60 + 59;j<=len_ - 1;j+=60){
						data_.push(min_chain_[j] / 10000);
					}
					var labels_ = [];
					for(let l_=0;l_<chart_column_num;l_++){
						labels_.push("");
					}
				}
				//alert(data_[0]);
				//eval('chLine' + i).data = min_chain_.slice(,min_chain_.length - 1) / 10000);
				//eval('chart' + i).data = full_data_; 
				//eval('chart' + i).data.datasets[0].data = [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]; 
				eval('chart'+a).data.labels = labels_;
				eval('chart'+a).data.datasets[0].data = data_;
				eval('chart'+a).update();
			}
		}
		function setupWebSocket(){
			this.socket = new WebSocket('ws://'+window.location.host+'/ws');
			this.socket.onopen = function(){
				socket.send('connect');
			}
			this.socket.onclose = function(){
				setTimeout(setupWebSocket, 1000);
			}
			// 서버로부터 update 문자열이 들어왔을 경우
			this.socket.onmessage = function(msg){
				if (msg.data == 'update'){
					// 업데이트 신호가 들어오면 해당 div를 갱신합니다
					// /update 페이지에 접속하고 서버에서 해당페이지는 데이터를 json형태로 반납합니다
					// 역시 vanilla js 를 사용해 봅니다
					var xhttp = new XMLHttpRequest();
					xhttp.onreadystatechange = function() {
						if (this.readyState == 4 && this.status == 200) {
							var data = JSON.parse(this.responseText);
							update_page(data);
						}
					};
					xhttp.open("GET", '/update/' + server + '/' + \
										cur_user + '/' + cur_itemset, true);
					xhttp.send();
					//$.getJSON('/update/' + server + '/' + cur_itemset, function(data){update_page(data);});
				}
			}
		}	

		function create_itemset() {
			openSetForm();
		}

		function coloring_setbutton(cur_set) {
			if(cur_set.trim() == '기본구성') {
				document.getElementById("button_itemset").className = \
					'btn btn-secondary btn-large btn-block dropdown-toggle text-warning';
			}
			else {
				document.getElementById("button_itemset").className = \
					'btn btn-secondary btn-large btn-block dropdown-toggle text-muted';
			}
		}

		function change_itemset(itemset){
			// 이후 각 드롭다운 항목들을 새로 만들어 교체해줍니다
			cur_itemset = itemset;
			document.getElementById("div_itemlist").innerHTML = ""; 
			for(let it=0;it<itemsets.length;it++){
				// cur_itemset이 아닌 항목들만 추가합니다
				if(itemsets[it] != itemset){
					document.getElementById("div_itemlist").innerHTML += "\
				<a id='itemlist" + it +"' class='dropdown-item text-center' href='#' onclick='change_itemset(\"" + itemsets[it] + "\");'>" + itemsets[it] + "</a>";
				}
			}
			if(itemset == '기본구성') {
				document.getElementById("button_itemset").innerHTML = \
				"<i class='far fa-file-alt' style='font-weight:lighter;font-size:1.0em'></i>&nbsp;&nbsp;" + itemset;
			}
			else {
				document.getElementById("button_itemset").innerHTML = itemset; 
			}
			//if(document.getElementById("button_itemset").innerHTML.trim() == '기본구성') {
			coloring_setbutton(itemset);
			## 혹시 아이템 입력창이 열려있을 수 있으므로 모두 닫습니다.
			for (let i=0;i<6;i++){
				closeForm(i);
			}

			## xmlrequest 전송전 버튼색상을 변경합니다
			##progress_start("button_itemset", "#3498db");
			##progress_start("button_itemset", "#aaaaaa");
			document.getElementById("div-spinner").style.display="flex";
			// 역시 vanilla js 로 변경해봅니다
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if(this.readyState == 4) {
					##progress_end("button_itemset");
					document.getElementById("div-spinner").style.display="none";
					if(this.status == 200) {
						var data = JSON.parse(this.responseText);
						update_page(data);
					}
				}
			};
			xhttp.open("GET", '/update/' + server + '/' + cur_user + '/' + itemset, true);
			xhttp.send();
			//$.getJSON('/update/' + server + '/' + itemset, function(data){update_page(data);});
		}

		function progress_start(id_, color_){
			##document.getElementById(id_).style.WebkitTransition = "background 3.2s";
			document.getElementById(id_).style.transition = "background 3.2s";
			##document.getElementById(id_).style.transitionTimingFunction = "linear";
			document.getElementById(id_).style.transitionTimingFunction = "ease";
			##document.getElementById(id_).style.background = "#e74c3c"; // danger red
			##document.getElementById(id_).style.background = "#00bc8c"; // success mint
			document.getElementById(id_).style.background = color_; // info lightblue
			##document.getElementById(id_).style.WebkitTransform = "scale(1.2)"; // info lightblue
			##document.getElementById(id_).style.transform = "scale(1.2)"; // info lightblue
		}
		function progress_end(id_){
			document.getElementById(id_).style.WebkitTransition = "all 0.1s";
			document.getElementById(id_).style.transition = "all 0.1s";
			document.getElementById(id_).style.background = "#444444";
			##document.getElementById(id_).style.WebkitTransform = "scale(1.0)"; // info lightblue
			##document.getElementById(id_).style.transform = "scale(1.0)"; // info lightblue
		}

		## 개별 아이템 업그레이드 함수입니다
		function update_indiv(data){
			var ar = data.indiv_ar;
			var i = data.num;
			if(!ar.name) return;
			document.getElementById("input-item"+i).value = '';
			document.getElementById("image"+i).setAttribute("style", "background-image: url('" + img_host + ar.image + ".jpg')"); 
			document.getElementById("itemname"+i).innerHTML = ar.name;
			document.getElementById("num"+i).innerHTML = ar.num;
			document.getElementById("moneygold"+i).innerHTML = ar.gold;
			document.getElementById("moneysilver"+i).innerHTML = ar.silver;
			document.getElementById("moneycopper"+i).innerHTML = ar.copper;
			document.getElementById("min_seller"+i).innerHTML = ar.min_seller;

			//실제로 클릭액션을 해야하는 클래스라 안먹힙니다
			//document.getElementById("lb"+i+"0").checked = 1; 
			document.getElementById("lb"+i+"0").click();
			
			## 아직chLine이 미처 생성되지 않았을 경우 exception이 발생해 이상동작이 발생하는듯 
			if(eval('chart'+i)){
				## chart_chain 전역배열변수에 일단 저장을 해야합니다
				chart_chains[i] = ar.min_chain;  
				min_chain_ = chart_chains[i];
				//alert(min_chain_[min_chain_.length - 1]);
				//eval('chLine' + i).data = min_chain_[min_chain_.length - 1] / 10000;
				var data_ = [],
					len_ = min_chain_.length;
				//alert(min_chain_[0]);
				for (let j=len_ - chart_column_num;j<=len_ - 1;j++){
				//for (i=0;i<=3;i++){
					data_.push(min_chain_[j] / 10000);
				}
				var labels_ = [];
				for(let l_=0;l_<chart_column_num;l_++){
					labels_.push("");
				}
				//alert(data_[0]);
				//eval('chLine' + i).data = min_chain_.slice(,min_chain_.length - 1) / 10000);
				//eval('chart' + i).data = full_data_; 
				//eval('chart' + i).data.datasets[0].data = [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]; 
				eval('chart'+i).data.labels = labels_;
				eval('chart'+i).data.datasets[0].data = data_;
				eval('chart'+i).update();
				//alert('엄지척');
				////eval('chLine' + i).addData = data_; 
				//eval('chLine' + i).update();
			}
		}

		## itemsets의 제일 앞에 생성(+)를 삽입해 줍니다
		function deco_itemsets() {
			//itemsets.unshift('+');
			//alert('deco' + itemsets[0]);
			if(itemsets[0] != ' 만들기') {
				itemsets.unshift(' 만들기');
			/*
			if(itemsets[0] != '+ 새로 만들기') {
				itemsets.unshift('+ 새로 만들기');
				*/
				//alert(itemsets[0]);
			}
		}

		## 전체 6개 아이템 업데이트 함수입니다
		function update_page(data){
			//alert(Object.keys(data).length);
			// data 갯수, 즉 6회동안 각 요소 갱신을 반복합니다
			##progress_end("button_itemset");
			##spinner 생성
			document.getElementById("div-spinner").style.display="flex";
			t = data.time;
			itemsets = data.itemsets;
			deco_itemsets();
			data = data.ar;
			//alert(data[0]['name']);
			## sort를 통해 아래와같이 할수도 있지만 이미 html상 해당id들이 정렬된채 생성된 상태라 상관없습니다
			for (let i=0;i < Object.keys(data).length;i++) {
			//Object.keys(data).sort().foreach(function(i) {
				//alert(i);
				document.getElementById("image"+i).setAttribute("style", "background-image: url('" + img_host + data[i].image + ".jpg')"); 
				document.getElementById("itemname"+i).innerHTML = data[i].name;
				document.getElementById("num"+i).innerHTML = data[i].num;
				document.getElementById("moneygold"+i).innerHTML = data[i].gold;
				document.getElementById("moneysilver"+i).innerHTML = data[i].silver;
				document.getElementById("moneycopper"+i).innerHTML = data[i].copper;
				document.getElementById("min_seller"+i).innerHTML = data[i].min_seller;

				//실제로 클릭액션을 해야하는 클래스라 안먹힙니다
				//document.getElementById("lb"+i+"0").checked = 1; 
				document.getElementById("lb"+i+"0").click();
				
				## 아직chLine이 미처 생성되지 않았을 경우 exception이 발생해 이상동작이 발생하는듯 
				try {
					if(eval('chart'+i)){
						//min_chain_ = data[Object.keys(data)[i]].min_chain;
						chart_chains[i] = data[i].min_chain;
						min_chain_ = chart_chains[i];
						//alert(min_chain_[min_chain_.length - 1]);
						//eval('chLine' + i).data = min_chain_[min_chain_.length - 1] / 10000;
						var data_ = [],
							len_ = min_chain_.length;
						//alert(min_chain_[0]);
						for (let j=len_ - chart_column_num;j<=len_ - 1;j++){
						//for (i=0;i<=3;i++){
							data_.push(min_chain_[j] / 10000);
						}
						var labels_ = [];
						for(let l_=0;l_<chart_column_num;l_++){
							labels_.push("");
						}
						//alert(data_[0]);
						//eval('chLine' + i).data = min_chain_.slice(,min_chain_.length - 1) / 10000);
						//eval('chart' + i).data = full_data_; 
						//eval('chart' + i).data.datasets[0].data = [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]; 
						eval('chart'+i).data.labels = labels_;
						eval('chart'+i).data.datasets[0].data = data_;
						eval('chart'+i).update();
						//alert('엄지척');
						////eval('chLine' + i).addData = data_; 
						//eval('chLine' + i).update();
					}
				}
				catch(error) {
				}
			}

			// 이후 각 드롭다운 항목들을 새로 만들어 교체해줍니다
			document.getElementById("div_itemlist").innerHTML = ""; 
			
			## 새로만들기항목
			document.getElementById("div_itemlist").innerHTML += "\
			<a id='itemlist0' class='dropdown-item text-center font-weight-bolder text-info' href='#' onclick='create_itemset();'> <i class='far fa-edit' style='font-weight:lighter;font-size:1.0em;'>&nbsp;</i>" + itemsets[0] + "</a>";
			## 아이템세트들
			window.dropdown_pair = {};
			for(let it=1;it<itemsets.length;it++){			//0이 아닌 1부터시작 
				// cur_itemset이 아닌 항목들만 추가합니다
				//alert(itemsets[it]);
				var cur = itemsets[it];
				if(cur != cur_itemset){
					if(cur == '기본구성') {
						document.getElementById("div_itemlist").innerHTML += " \
						<a id='itemlist" + it +"' class='dropdown-item text-center text-warning' href='#' onclick='change_itemset(\"" + cur + "\");'><i class='far fa-file-alt' style='font-weight:lighter;font-size:1.0em'></i>&nbsp;&nbsp;" + cur + "</a>";
					}
					else {
						## 아이템명 뒤에 휴지통을 추가합니다
						dropdown_pair[it] = cur;
						document.getElementById("div_itemlist").innerHTML += \
							"<div id='dropdown-delete" + it + "' class='dropdown-delete'>" + 
							"<i class='far fa-trash-alt text-muted'></i></div>" +
							"<a id='itemlist" + it +"' class='dropdown-item text-center'" +
							"href='#' onclick='change_itemset(\"" + cur + "\");'>" + cur + "</a>";
					}
				}
			}
			## 위의 if-else 내에서 innerHTML 작성하면서 addeventlistener를 행하니 동작하지 않았습니다. 
			## 그래서 for loop 번거롭지만 별도로 뺐습니다.
			for(let it=1;it<itemsets.length;it++){			//0이 아닌 1부터시작 
				if(document.getElementById('dropdown-delete'+it)){
					//alert(document.getElementById('ddelete'+it).innerHTML);
					//document.getElementById('ddelete'+it).addEventListener("click", function() {getget();}, true); 
					document.getElementById('dropdown-delete'+it).addEventListener("click", function(){
						delete_itemset(dropdown_pair[it]);}); 
				}
			}

			//alert(document.getElementById("button_itemset").innerHTML.trim());

			//document.getElementById("button_itemset").innerHTML = cur_itemset;
			
			if(cur_itemset == '기본구성') {
				document.getElementById("button_itemset").innerHTML = "<i class='far fa-file-alt' style='font-weight:lighter;font-size:1.0em'></i>&nbsp;&nbsp;" + cur_itemset; 
			}
			else {
				document.getElementById("button_itemset").innerHTML = cur_itemset;
			}
		
			coloring_setbutton(cur_itemset);
			document.getElementById("update_time").innerHTML = t;
			##spinner 제거
			document.getElementById("div-spinner").style.display="none";

			/*
			var lbs = document.getElementsByTagName("label");
			alert(lbs.length);
			for(let i=0;i<lbs.length;i++) {

			}
			*/
			//alert('엄지척');
		} //function update_page() ends

		function delete_itemset(setname) {
			alert('delete ' + setname + '!!');
			## modal
			document.getElementById("div-spinner").style.display="flex";
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if(this.readyState == 4) {
					document.getElementById("div-spinner").style.display="none";
					if (this.status == 200) {
						var data = JSON.parse(this.responseText);
						//alert(data.success);
						if(data.success == '1') {
							## 삭제성공하였을 경우 처리합니다
							var xhtp = new XMLHttpRequest();
							xhtp.onreadystatechange = function() {
								if (this.readyState == 4) {
									if(this.status == 200) {	
										var data = JSON.parse(this.responseText);
										update_page(data);
									}
								}
							};
							## 마지막 'd'는 itemset의 성질을 나타냅니다. default로서 fame증가등을 하지 않습니다
							xhtp.open("GET", '/update/' + server + '/' + \
												cur_user + '/' + cur_itemset , true);
							xhtp.send();
						}
					}
				}
			};
			xhttp.open("GET", '/delete_itemset/' + cur_user + '/' + setname ,true);
			xhttp.send();
		}
		function openSetForm() {
			document.getElementById("div-form-itemset").style.display = 'flex';
			document.getElementById("input-itemset").focus();
			document.getElementById('icon-set-cancel').style.display = 'flex';
		}

		function closeSetForm() {
			document.getElementById("div-form-itemset").style.display = 'none';
			document.getElementById('icon-set-cancel').style.display = 'none';
		}

		function closeForm(num) {
			document.getElementById('div-form-item'+num).style.display = 'none';
			document.getElementById('icon-cancel'+num).style.display = 'none';
			form_opened[num] = 0;
		}
		function openForm(num) {
			document.getElementById('div-form-item'+num).style.display = 'flex';
			document.getElementById("input-item"+num).focus();
			document.getElementById('icon-cancel'+num).style.display = 'flex';
			form_opened[num] = 1;
		}
		// jQuery document ready 를 대신하는 자바스크립트입니다 다만 익스플로러 9이하에선 안된다는 말도 있네요
		document.addEventListener("DOMContentLoaded", function(){
			window.checked = new Array;
			window.addEventListener("keydown", function (event) {
				//alert(event.key);
				if(event.key == "Escape"){
					for(let i=0;i<6;i++) {
						closeForm(i);
					}
					closeSetForm();
				}
			});
			for (let uu=0;uu<6;uu++) {
				checked[uu] = 0;
				document.getElementById('lb' + uu + '0').addEventListener('click', function () {update_chart(uu, 0);}, false);
				document.getElementById('lb' + uu + '1').addEventListener('click', function () {update_chart(uu, 1);}, false);
				document.getElementById('lb' + uu + '2').addEventListener('click', function () {update_chart(uu, 2);}, false);
				document.getElementById('lb' + uu + '3').addEventListener('click', function () {update_chart(uu, 3);}, false);
				document.getElementById('lb' + uu + '4').addEventListener('click', function () {update_chart(uu, 4);}, false);
				document.getElementById("icon-cancel"+uu).addEventListener('click', function() { \
					if(document.getElementById("input-item"+uu).value == '') {
						closeForm(uu);
					}
					else {
						document.getElementById("input-item"+uu).value=''; 
						document.getElementById("input-item"+uu).focus();
					}
				}, false);
			}
			document.getElementById("icon-set-cancel").addEventListener('click', function() { \
				t = document.getElementById("input-itemset").value; 
				if(t == '') {
					closeSetForm();
				}
				else {
					document.getElementById("input-itemset").value=''; 
					document.getElementById("input-itemset").focus();
				}
			}, false);
	

			setupWebSocket();
			// innerHTML
			document.getElementById("designed_by").innerHTML = "developed and designed by utylee studios 2019 /&nbsp;";
			document.getElementById("gathered_from").innerHTML = "item images hosted by zamimg.com /&nbsp; ";
			document.getElementById("dumped_at").innerHTML = "${server} DB dumped recently at &nbsp;";
			## donation 제거
			##document.getElementById("thx_for").innerHTML = "thanks for your";
			##document.getElementById("donation").innerHTML = "<a href='http://npay.to/15fe4a50e584e996c30f' target='_blank'>NPay donation</a>";
			http://npay.to/15fe4a50e584e996c30f
			// websocket을 만듭니다
			// 차트객체 chart.js 6개를 생성합니다
			% for a in ar.keys():
			var data_ = [];
			//alert('${ar[a]['min_chain'][-1]}');
			
			##% for m_ in ar[a]['min_chain'][-15:]:
				####data_.push(Math.floor(${m_}/10000));
				##data_.push(${m_}/10000);
			##% endfor
			var cur_min_chain = ${ar[a]['min_chain']};
			for(let ii = cur_min_chain.length - chart_column_num;ii <= cur_min_chain.length - 1; ii++){
				data_.push(cur_min_chain[ii]/10000);
			}

			var labels_ = [];
			for(let l_=0;l_<chart_column_num;l_++){
				labels_.push("");
			}
			window.chartData${loop.index} = {
				/*
				labels: ["", "", "", "", "", "", "", "", "", "",\
						"", "", "", "", ""], //"", "", ""],
						*/
				labels: labels_,
				datasets: [{
					data: data_
				}
				]
			};

			window.chLine${loop.index} = document.getElementById("chLine${loop.index}");
			if(chLine${loop.index}) {
				window.chart${loop.index} = new Chart(chLine${loop.index}, {
					type: 'line',
					data: chartData${loop.index},
					options: {
						scales: {
							yAxes: [{
								ticks: {
									beginAtZero: false
								}
							}]
						},
						legend: {
							display: false
						}
					}
				});
			}
			% endfor
		});
	</script>
</%block>

<%block name="content">
<div class="my-container" >

	## ---------------------------------------------------------------
	## 상단 row
	<div class="my-header">
		## 아즈샤라 서버
		<div class="dropdown menu_wide_narrow" >
			<button  class="btn btn-secondary btn-large btn-block text-muted dropdown-toggle " type="button" data-toggle="dropdown" >
				##<span class="glyphicon glyphicon-grain" aria-hidden="true"></span>
				<i class="fas fa-check-circle text-success">&nbsp;</i>
				아즈샤라
				##<span class="icon-checkcircle" >아즈샤라</span>
			</button>
		</div>
		## 아이템 세트 셀렉트 
		<div class="temple_btn">
		<div id="div-spinner"><div class="spinner"></div></div>
		<div class="dropdown menu_wide" >
			##<button id="button_itemset" class="btn btn-secondary btn-large btn-block text-muted dropdown-toggle " type="button" data-toggle="dropdown">
			% if current_itemset == '기본구성':
			<button id="button_itemset" class="btn btn-secondary btn-large btn-block dropdown-toggle text-warning" type="button" data-toggle="dropdown">
				<i class='far fa-file-alt' style='font-weight:lighter;font-size:1.0em'></i>&nbsp;&nbsp;${current_itemset}</button>
			% else:
			<button id="button_itemset" class="btn btn-secondary btn-large btn-block dropdown-toggle text-muted" type="button" data-toggle="dropdown">${current_itemset}</button>
			% endif
			<div id="div_itemlist" class="dropdown-menu scrollable-menu"  style="width:100%">
				% for i in itemsets:
					% if i == '만들기':
				<a id="${'itemlist'+str(loop.index)}" class="dropdown-item text-center text-primary" href="#" onclick="change_itemset('${i}');"><h2>${i}</h2></a>
					% elif i == '기본구성':
				<a id="${'itemlist'+str(loop.index)}" class="dropdown-item text-center text-warning" href="#" onclick="change_itemset('${i}');">${i}</a>
					% else:
				<a id="${'itemlist'+str(loop.index)}" class="dropdown-item text-center" href="#" onclick="change_itemset('${i}');">${i}</a>
					% endif
				% endfor
			</div>
		</div>
		<div id="div-form-itemset" class="input_wide" align="center">
			<form action="javascript:submit_itemset_form();" >
				<input id="input-itemset" class="form-control-itemset" type="text" placeholder="만들 세트명을 입력하세요">
				<button id="itemset-confirm" class="btn btn-lg btn-success " type="submit">
				##<button id="itemset-confirm" class="btn-info " type="submit">
					확인
				</button>
			</form>
		<div id="icon-set-cancel" >
			X		
		</div>
		</div>
		</div>
		## 로그인 
		<div class="menu_narrow">
			<button id="button_login" class="btn btn-info btn-block " type="button">
				로그인	
			</button>
		</div>
	</div>

	## ---------------------------------------------------------------
	## ---------------------------------------------------------------
	## 메인 row
	<div class="my-main">
			## % for a in ar.keys():
			% for a, b in sorted(ar.items()):
			<div class="card" >
				<div class="card-img-top bg-secondary"  >
					<center>
						<%doc>
						border를 img태그를 이용하고 아이템이미지를 div의 백그라운드로 거꾸로 사용해서
						border가 잘리는문제를 해결하였습니다
						</%doc>
						##<div id="image${loop.index}" class="iconlarge" style="background-image: url('${imageroot + ar[a]['image']}'+'.jpg')">
						<div id="image${a}" class="iconlarge" style="background-image: url('${imageroot + b['image'] + '.jpg'}')">
							<a href="javascript:show_item_form(${a});">
								## nginx 에서 static 을 호스팅하느라 상대경로를 바꿨습니다
								##<img src="../static/css/images/border.png"/>
								<img src="/static/css/images/border.png"/>
							</a>
						</div>
					</center>
				</div>

				<div class="card-body main-item" >
					## 아이템명 변경 입력 팝업입니다
					<div id="div-form-item${a}" align="center">
						<form action="javascript:submit_item_form(${a});" >
							<input id="input-item${a}" class="form-control-item" type="text" placeholder="아이템명을 입력하세요">
							<button class="btn btn-info btn-lg item-confirm" type="submit">
								확인
							</button>
						</form>
					</div>
					<div id="icon-cancel${a}" >
						X		
					</div>
					<div class="card-title" align="center"  >
						<a href="javascript:show_item_form(${a});"><span id="itemname${a}" style="font-size:1.2rem">${b['name']}</span><span id="num${a}" class="badge badge-success badge-pill" >${b['num']}</span>
						</a>
					</div>
					<ul class="list-group list-group-flush">
					<li class="list-group-item">
					<p class="card-text" align="center">
					<span id="moneygold${loop.index}" class="moneygold">${int(b['gold'])}</span>
					<span id="moneysilver${loop.index}" class="moneysilver">${int(b['silver'])}</span>
					<span id="moneycopper${loop.index}" class="moneycopper">${int(b['copper'])}</span>
					<br>
					<span id="min_seller${loop.index}" class="badge badge-secondary text-muted" >${b['min_seller']}</span>
					</p>
					</li>
					<div style="font-size:12px;margin-top:0px;" align="center">
						##차트
						<li class="list-group-item" align="center">
							<canvas id="chLine${loop.index}"></canvas>
						##주기선택
							##<div align="center" class="btn-block btn-group-sm btn-group-toggle center" style="transform:scale(0.6);" data-toggle="buttons">
							<div align="center" class="btn-group btn-group-toggle center"  data-toggle="buttons">
								<label id="lb${loop.index}0" class="btn btn-outline-primary text-muted active">
									<input type="radio" name="options" id="option1" autocomplete="off">12시
								</label>
								<label id="lb${loop.index}1" class="btn btn-outline-primary text-muted">
									<input type="radio" name="options" id="option2" autocomplete="off">24시
								</label>
								<label id="lb${loop.index}2" class="btn btn-outline-primary text-muted">
									<input type="radio" name="options" id="option3" autocomplete="off">48시
								</label>
								<label id="lb${loop.index}3" class="btn btn-outline-primary text-muted">
									<input type="radio" name="options" id="option3" autocomplete="off">주일
								</label>
								<label id="lb${loop.index}4" class="btn btn-outline-primary text-muted">
									<input type="radio" name="options" id="option4" autocomplete="off">30일
								</label>
							</div>
						</li>
					</div>
					</ul>
				</div>
			</div>
			% endfor
	</div>

	## ---------------------------------------------------------------
	## bottom row
	<div class="my-footer">
		<div >
			<span id="designed_by" class="text-secondary "></span>
			<span id="gathered_from" class="text-secondary "></span>
			<span id="dumped_at" class="text-secondary "></span>
			<span id="update_time" class="text-primary "></span>
			<br>
			<%doc>
			<span id="thx_for" class="text-secondary "></span>
			<span id="donation" class="text-muted"></span>
			</%doc>
		</div>
	</div>
</div>
</%block>
